openapi: 3.0.3
info:
  title: Medama Analytics API
  version: 0.1.0
  description: |
    This is the Medama Analytics OpenAPI 3.0 specification.
  contact:
    email: hello@ayuhito.com
    name: Medama Analytics
    url: https://medama.io/contact
  license:
    url: "https://github.com/ayuhito/medama/blob/main/core/LICENSE"
    name: BUSL 1.1
servers:
  - url: "http://localhost:8080"
    description: Local Server
tags:
  - name: auth
    description: Authentication
  - name: event
    description: Page Events
  - name: user
    description: User Management
  - name: website
    description: Website Management
  - name: stats
    description: Statistics
paths:
  /auth/login:
    post:
      tags:
        - auth
      summary: Session Token Authentication.
      description: Login to the service and retrieve a session token for authentication.
      operationId: post-auth-login
      requestBody:
        description: Login details.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLogin"
        required: true
      responses:
        "200":
          description: Success
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Set the cookie for the session.
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
  /event/hit:
    post:
      tags:
        - event
      summary: Send Hit Event.
      description: Send a hit event to register a user view.
      operationId: post-event-hit
      parameters:
        - name: User-Agent
          in: header
          schema:
            type: string
        - name: Accept-Language
          in: header
          description: Used to infer user language.
          schema:
            type: string
        - name: Sec-Ch-Ua
          in: header
          schema:
            type: string
        - name: Sec-Ch-Ua-Mobile
          in: header
          schema:
            type: string
        - name: Sec-Ch-Ua-Platform
          in: header
          schema:
            type: string
      requestBody:
        description: Hit event metadata.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EventHit"
        required: true
      responses:
        "200":
          description: OK.
        "404":
          description: Not Found
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
  /event/ping:
    get:
      tags:
        - event
      summary: Unique User Check.
      description: This is a ping endpoint to determine if the user is unique or not.
      operationId: get-event-ping
      parameters:
        - name: Last-Modified
          in: header
          description: If this exists, then user exists in cache and is not a unique user.
          schema:
            type: string
      responses:
        "200":
          description: OK
          headers:
            Last-Modified:
              schema:
                type: string
              description: This is date of the current day from midnight, incremented by each page view by unique user.
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
  /user:
    get:
      tags:
        - user
      security:
        - CookieAuth: []
      summary: Get User Info.
      description: Retrieve the information of the user with the matching user ID.
      operationId: get-user
      parameters:
        - $ref: "#/components/parameters/SessionAuth"
      responses:
        "200":
          description: User Found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserGet"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
    post:
      tags:
        - user
      summary: Create New User.
      description: Create a new user.
      operationId: post-user
      requestBody:
        description: Post the necessary fields for the API to create a new user.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserCreate"
        required: true
      responses:
        "201":
          description: User Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserGet"
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Set the cookie for the session.
          links:
            GetUser:
              operationId: get-user
              parameters:
                SessionAuth: $response.header.Set-Cookie
            PatchUser:
              operationId: patch-user
              parameters:
                SessionAuth: $response.header.Set-Cookie
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "409":
          $ref: "#/components/responses/ConflictError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
    patch:
      tags:
        - user
      security:
        - CookieAuth: []
      summary: Update User Info.
      description: Update a user account's details.
      operationId: patch-user
      parameters:
        - $ref: "#/components/parameters/SessionAuth"
      requestBody:
        description: User details to update.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserPatch"
        required: true
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserGet"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "409":
          $ref: "#/components/responses/ConflictError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
    delete:
      tags:
        - user
      security:
        - CookieAuth: []
      summary: Delete User.
      description: Delete a user account.
      operationId: delete-user
      parameters:
        - $ref: "#/components/parameters/SessionAuth"
      responses:
        "200":
          description: Success
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "409":
          $ref: "#/components/responses/ConflictError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
  /websites:
    get:
      tags:
        - website
      security:
        - CookieAuth: []
      summary: List Websites.
      description: Get a list of all websites from the user.
      operationId: get-websites
      parameters:
        - $ref: "#/components/parameters/SessionAuth"
      responses:
        "200":
          description: Returns a list of websites.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/WebsiteGet"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
    post:
      tags:
        - website
      security:
        - CookieAuth: []
      summary: Add Website.
      description: Add a new website.
      operationId: post-websites
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebsiteCreate"
        required: true
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebsiteGet"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "409":
          $ref: "#/components/responses/ConflictError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
  "/websites/{hostname}":
    get:
      tags:
        - website
      security:
        - CookieAuth: []
      summary: Get Website.
      description: Get website details for an individual website.
      operationId: get-websites-id
      parameters:
        - $ref: "#/components/parameters/SessionAuth"
        - $ref: "#/components/parameters/Hostname"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebsiteGet"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
    patch:
      tags:
        - website
      security:
        - CookieAuth: []
      summary: Update Website.
      description: Update a website's information.
      operationId: patch-websites-id
      parameters:
        - $ref: "#/components/parameters/SessionAuth"
        - $ref: "#/components/parameters/Hostname"
      requestBody:
        description: Website details to update.
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WebsitePatch"
        required: true
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebsiteGet"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
    delete:
      tags:
        - website
      security:
        - CookieAuth: []
      summary: Delete Website.
      description: Delete a website.
      operationId: delete-websites-id
      parameters:
        - $ref: "#/components/parameters/SessionAuth"
        - $ref: "#/components/parameters/Hostname"
      responses:
        "200":
          description: Success
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
  "/websites/{hostname}/active":
    get:
      tags:
        - stats
      security:
        - CookieAuth: []
      summary: Get Active Users.
      description: Return the number of active users who triggered a pageview in the past 5 minutes.
      operationId: get-websites-id-active
      parameters:
        - $ref: "#/components/parameters/SessionAuth"
        - $ref: "#/components/parameters/Hostname"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatsActive"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
  "/website/{hostname}/summary":
    get:
      tags:
        - stats
      security:
        - CookieAuth: []
      summary: Get Stat Summary.
      description: Get a summary of the website's stats.
      operationId: get-website-id-summary
      parameters:
        - $ref: "#/components/parameters/SessionAuth"
        - $ref: "#/components/parameters/PeriodStart"
        - $ref: "#/components/parameters/PeriodEnd"
        - $ref: "#/components/parameters/Hostname"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatsSummary"
        "400":
          $ref: "#/components/responses/BadRequestError"
        "401":
          $ref: "#/components/responses/UnauthorisedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "500":
          $ref: "#/components/responses/InternalServerError"
      servers:
        - url: "http://localhost:8080"
          description: Local Server
components:
  securitySchemes:
    CookieAuth:
      name: _me_sess
      in: cookie
      type: apiKey
      description: Session token for authentication.
  parameters:
    SessionAuth:
      name: _me_sess
      in: cookie
      description: Session token for authentication.
      required: true
      schema:
        type: string
    Hostname:
      name: hostname
      in: path
      description: Hostname for the website.
      required: true
      schema:
        type: string
        minLength: 1
        maxLength: 253 # FQDN limit
        format: hostname
    PeriodStart:
      name: start
      in: query
      description: Start time (seconds) in Unix epoch format.
      required: false
      schema:
        type: string
    PeriodEnd:
      name: end
      in: query
      description: End time (seconds) in Unix epoch format.
      required: false
      schema:
        type: string
  responses:
    BadRequestError:
      description: 400 Bad Request.
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                additionalProperties: false
                properties:
                  code:
                    type: integer
                    format: int32
                    default: 400
                  message:
                    type: string
                required:
                  - code
                  - message
            required:
              - error
    UnauthorisedError:
      description: 401 Unauthorised.
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                additionalProperties: false
                properties:
                  code:
                    type: integer
                    format: int32
                    default: 401
                  message:
                    type: string
                required:
                  - code
                  - message
            required:
              - error
    ForbiddenError:
      description: 403 Forbidden.
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                additionalProperties: false
                properties:
                  code:
                    type: integer
                    format: int32
                    default: 403
                  message:
                    type: string
                required:
                  - code
                  - message
            required:
              - error
    NotFoundError:
      description: 404 Not Found.
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                additionalProperties: false
                properties:
                  code:
                    type: integer
                    format: int32
                    default: 404
                  message:
                    type: string
                required:
                  - code
                  - message

            required:
              - error
    ConflictError:
      description: 409 Conflict Found.
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                additionalProperties: false
                properties:
                  code:
                    type: integer
                    format: int32
                    default: 409
                  message:
                    type: string
                required:
                  - code
                  - message
            required:
              - error
    InternalServerError:
      description: 500 Unexpected Internal Server Error.
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                additionalProperties: false
                properties:
                  code:
                    type: integer
                    format: int32
                    default: 500
                  message:
                    type: string
                required:
                  - code
                  - message
            required:
              - error
  schemas:
    AuthLogin:
      type: object
      title: AuthLogin
      description: Request body for logging in.
      properties:
        email:
          type: string
          minLength: 3
          maxLength: 320
          format: email
        password:
          type: string
          minLength: 8
          maxLength: 128
          format: password
      required:
        - email
        - password
    EventHit:
      type: object
      title: EventHit
      description: Website hit event.
      properties:
        b:
          type: string
          description: UUID generated for each user to link multiple events on the same page together.
        u:
          type: string
          description: Page URL including query parameters.
        r:
          type: string
          description: Referrer URL.
        e:
          type: string
          description: "Event type consisting of either 'pagehide', 'unload', 'load', 'hidden' or 'visible'."
        t:
          type: integer
          description: Title of page.
        d:
          type: string
          description: Timezone of the user.
        w:
          type: integer
          description: Screen width.
        h:
          type: integer
          description: Screen height.
        m:
          type: integer
          description: Time spent on page. Only sent on unload.
      required:
        - b
        - u
        - r
        - e
    UserCreate:
      type: object
      title: UserCreate
      description: Request body for creating a user.
      properties:
        email:
          type: string
          minLength: 3
          maxLength: 320
          format: email
        password:
          type: string
          minLength: 8
          maxLength: 128
          format: password
        language:
          type: string
          enum: [en]
          default: en
      required:
        - email
        - password
    UserGet:
      type: object
      title: UserGet
      description: Response body for getting a user.
      properties:
        email:
          type: string
          minLength: 3
          maxLength: 320
          format: email
        language:
          type: string
          enum: [en]
          default: en
        dateCreated:
          type: integer
          format: int64
        dateUpdated:
          type: integer
          format: int64
      required:
        - email
        - language
        - dateCreated
        - dateUpdated
    UserPatch:
      type: object
      title: UserPatch
      description: Request body for updating a user.
      properties:
        email:
          type: string
          minLength: 3
          maxLength: 320
          format: email
        password:
          type: string
          minLength: 8
          maxLength: 128
          format: password
        language:
          type: string
          enum: [en]
          default: en
    WebsiteGet:
      type: object
      title: WebsiteGet
      description: Response body for getting a website.
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 256
        hostname:
          type: string
          minLength: 1
          maxLength: 253 # FQDN limit
          format: hostname
      required:
        - name
        - hostname
    WebsiteCreate:
      type: object
      title: WebsiteCreate
      description: Request body for creating a website.
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 256
        hostname:
          type: string
          minLength: 1
          maxLength: 253 # FQDN limit
          format: hostname
      required:
        - name
        - hostname
    WebsitePatch:
      type: object
      title: WebsitePatch
      description: Request body for updating a website.
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 256
        hostname:
          type: string
          minLength: 1
          maxLength: 253 # FQDN limit
          format: hostname
    StatsActive:
      type: object
      title: StatsActive
      description: Return the number of active realtime users.
      properties:
        visitors:
          type: integer
      required:
        - visitors
    StatsSummary:
      type: object
      title: StatsSummary
      properties:
        uniques:
          type: integer
        pageviews:
          type: integer
        bounces:
          type: number
          format: float
        duration:
          type: integer
